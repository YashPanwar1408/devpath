// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id // Clerk user ID
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  progress          UserProgress[]
  submissions       Submission[]
  interviewSessions InterviewSession[]
  sharedResults     SharedInterviewResult[]
  analytics         InterviewAnalytics?
}

model DSATopic {
  id          String      @id @default(uuid())
  slug        String      @unique
  title       String
  category    String?
  order       Int
  targetCount Int         @default(0)
  lessons     DSALesson[]
  createdAt   DateTime    @default(now())
}

model DSALesson {
  id           String   @id @default(uuid())
  topicId      String
  topic        DSATopic @relation(fields: [topicId], references: [id], onDelete: Cascade)
  slug         String   @unique
  title        String
  content      String   @db.Text // markdown
  codeExamples Json?
  difficulty   String?
  order        Int
  createdAt    DateTime @default(now())

  @@index([topicId])
}

model Problem {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  difficulty  String
  description String   @db.Text
  examples    Json
  constraints String[]
  starterCode Json
  solutions   Json?    // { brute: {...}, optimized: {...} }
  testCases   Json?    // [{ input, expected }]
  pattern     String
  sheets      String[]
  order       Int
  createdAt   DateTime @default(now())

  progress    UserProgress[]
  submissions Submission[]
}

model UserProgress {
  id        String @id @default(uuid())
  userId    String
  problemId String

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  problem Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)

  status      String
  starred     Boolean  @default(false)
  lastAttempt DateTime @default(now())
  createdAt   DateTime @default(now())

  @@unique([userId, problemId])
  @@index([userId])
  @@index([problemId])
}

model Submission {
  id        String   @id @default(uuid())
  userId    String
  problemId String
  code      String   @db.Text
  language  String
  status    String   // Accepted, Wrong Answer, TLE, Compilation Error
  runtime   Int?     // ms
  memory    Int?     // KB
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  problem Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([problemId])
}

// Learn Platform Models
model LearnDomain {
  id         String          @id @default(uuid())
  slug       String          @unique
  title      String
  createdAt  DateTime        @default(now())
  categories LearnCategory[]
}

model LearnCategory {
  id       String       @id @default(uuid())
  title    String
  order    Int
  domainId String
  domain   LearnDomain  @relation(fields: [domainId], references: [id], onDelete: Cascade)
  topics   LearnTopic[]

  @@index([domainId])
}

model LearnTopic {
  id         String        @id @default(uuid())
  title      String
  slug       String        @unique
  order      Int
  content    String        @db.Text
  categoryId String
  category   LearnCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt  DateTime      @default(now())

  @@index([categoryId])
}

// ============================================================================
// AI MOCK INTERVIEW SYSTEM
// ============================================================================

model InterviewSession {
  id               String   @id @default(uuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Interview Details
  role             String   // frontend, backend, fullstack, etc.
  duration         Int      // minutes (10, 15, 20)
  status           String   // setup, ready, in-progress, completed, cancelled
  
  // Context
  resumeSnapshot   String   @db.Text // JSON stringified resume
  jobDescription   String?  @db.Text
  resumeSummary    String?  @db.Text // Gemini-generated
  jdSummary        String?  @db.Text // Gemini-generated
  
  // Vapi Integration
  vapiCallId       String?
  vapiAssistantId  String?
  
  // Transcript
  transcript       Json?    // { messages: [], fullTranscript: "" }
  
  // Video Recording
  videoUrl         String?  // S3/storage URL
  videoRecorded    Boolean  @default(false)
  
  // Timestamps
  createdAt        DateTime @default(now())
  startedAt        DateTime?
  endedAt          DateTime?
  
  // Relations
  feedback         InterviewFeedback?
  sharedResult     SharedInterviewResult?
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model InterviewFeedback {
  id                   String           @id @default(uuid())
  sessionId            String           @unique
  session              InterviewSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Overall Score
  overallScore         Int              // 0-100
  
  // Detailed Metrics
  communicationClarity Int              // 0-10
  technicalDepth       Int              // 0-10
  confidence           Int              // 0-10
  roleAlignment        Int              // 0-10
  
  // Skill Ratings
  skillRatings         Json             // [{ skill, rating, comment }]
  
  // Feedback
  strengths            String[]
  weaknesses           String[]
  improvements         String[]
  suggestedTopics      String[]
  
  // Learning Path
  learningRoadmap      String           @db.Text // Markdown formatted
  
  // AI Summary
  aiSummary            String           @db.Text
  
  createdAt            DateTime         @default(now())
  
  @@index([sessionId])
}

model QuestionBank {
  id          String   @id @default(uuid())
  role        String   // frontend, backend, fullstack, etc.
  difficulty  String   // easy, medium, hard
  category    String   // technical, behavioral, problem-solving
  
  question    String   @db.Text
  followUps   String[] // Follow-up questions
  keyPoints   String[] // Key points to evaluate
  
  // Metadata
  tags        String[]
  active      Boolean  @default(true)
  usageCount  Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([role])
  @@index([difficulty])
  @@index([active])
}

model SharedInterviewResult {
  id           String           @id @default(uuid())
  sessionId    String           @unique
  session      InterviewSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId       String
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Share Settings
  shareToken   String           @unique // URL-safe token
  isPublic     Boolean          @default(false)
  expiresAt    DateTime?
  
  // View Statistics
  viewCount    Int              @default(0)
  lastViewedAt DateTime?
  
  createdAt    DateTime         @default(now())
  
  @@index([shareToken])
  @@index([userId])
}

model InterviewAnalytics {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Aggregated Statistics
  totalInterviews       Int      @default(0)
  averageScore          Float    @default(0)
  averageCommunication  Float    @default(0)
  averageTechnical      Float    @default(0)
  averageConfidence     Float    @default(0)
  
  // Role-specific stats
  roleStats            Json     // { frontend: {...}, backend: {...} }
  
  // Performance Trends (monthly)
  monthlyScores        Json     // [{ month, avgScore, count }]
  
  // Top Strengths/Weaknesses
  topStrengths         String[]
  topWeaknesses        String[]
  
  lastUpdated          DateTime @updatedAt
}
